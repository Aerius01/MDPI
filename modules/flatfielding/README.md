# Flatfielding Module

## Abstract

The Flatfielding module is a crucial component in the image processing pipeline, following the `depth_profiling` stage. It is designed to correct for non-uniform illumination and sensor sensitivity variations in raw images. This correction, known as flat-fielding, ensures that the brightness and contrast of the images are uniform, which is essential for accurate subsequent analysis like object detection and classification. Additionally, this module applies a correction for pixel overlap between consecutive images based on depth profile data, effectively removing redundant information.

## How it Works

The module's logic is broken down into several key steps to achieve the flat-field correction and overlap removal:

1.  **Metadata and Data Ingestion:** The process begins by parsing essential metadata (such as project name, date, and location) from the input directory's path. It simultaneously loads the raw image paths and reads a user-provided depth profiles CSV file (which is typically generated by the previous module in the chain: the depth profiling module).

2.  **Average Image Calculation:** The module computes an "average image" by averaging the pixel values across all input images. This average image represents the characteristic pattern of non-uniform illumination and sensor defects. To prevent division-by-zero errors during the correction step, any pixel with a value of 0 in the average image is set to 1, where pixel values exist on the range [0, 255].

3.  **Flat-Field Correction:** Each raw image is then corrected individually. The correction is performed by dividing the raw image by the calculated average image on a pixel-by-pixel basis. The result is then multiplied by a `NORMALIZATION_FACTOR`. The formula is as follows:
    `corrected_image = (original_image / average_image) * NORMALIZATION_FACTOR`
    The pixel values of the corrected image are clipped to the valid 8-bit range [0, 255].

4.  **Overlap Correction:** Using the data from the depth profiles CSV, the module identifies the number of overlapping pixels (`pixel_overlap`) at the top of each image. These overlapping rows of pixels are then whited-out (set to 255), ensuring that each feature is represented only once in the dataset.

5.  **Saving the Output:** The fully corrected images are saved to the `<output_folder>/flatfielded_images` folder. The filenames are standardized based on the recording start time and a replicate number extracted from the original filename.

## Constants, Concerns, and Limitations

### Constants

-   **`NORMALIZATION_FACTOR` (235):** This factor is used to scale the image brightness after the division by the average image. It is an empirically derived value. Its optimal value might vary with different camera setups, lighting conditions, or water turbidity. Users may need to adjust this constant for their specific datasets if the output images appear too dark or too bright.

### Concerns and Limitations

-   **Average Image Assumption:** The effectiveness of the flat-fielding correction relies on the assumption that the average of all images accurately captures the static illumination pattern and sensor noise. If the objects being imaged are not sufficiently varied or are consistently located in the same regions, their features might be incorporated into the "average image", leading to the creation of artifacts in the corrected images.
-   **Dependency on Depth Profiles:** The overlap correction is entirely dependent on the accuracy of the `pixel_overlap` values provided in the depth profiles CSV. Inaccurate values will result in either incomplete removal of overlap or the cropping of valid image data.
-   **Hardcoded Values:** The `NORMALIZATION_FACTOR` is hardcoded. For different hardware or environmental conditions, this value may not be optimal and could require code modification to adjust.
